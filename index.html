<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhật Ký Lớp 2A8 - Collaborative App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-8 space-y-6">
            <header class="text-center">
                <h1 class="text-4xl font-extrabold text-indigo-700">
                    Nhật Ký Lớp 2A8
                </h1>
                <p class="text-gray-500 mt-2">Ứng dụng cộng tác thời gian thực (HTML/JS)</p>
            </header>

            <div id="error-message" class="hidden p-4 text-sm text-red-800 bg-red-100 rounded-lg" role="alert">
                <span class="font-medium">Lỗi nghiêm trọng:</span> <span id="error-text"></span>
            </div>

            <section class="p-4 bg-indigo-50 border border-indigo-200 rounded-lg text-sm space-y-1">
                <h2 class="text-xl font-semibold text-indigo-600 mb-2">Thông tin hệ thống</h2>
                <p class="text-gray-700">
                    **App ID:** <span id="app-id" class="font-mono text-xs break-all bg-yellow-100 p-1 rounded">Đang tải...</span>
                </p>
                <p class="text-gray-700">
                    **User ID:** <span id="user-id" class="font-mono text-xs break-all bg-yellow-100 p-1 rounded">Đang xác thực...</span>
                </p>
                <p class="text-gray-700">
                    **Trạng thái DB:** <span id="db-status">Đang khởi tạo...</span>
                </p>
            </section>
            
            <section class="text-center p-6 bg-indigo-100 rounded-xl shadow-inner min-h-32 flex flex-col justify-center">
                <h2 class="text-2xl font-bold text-indigo-800 mb-4">Tin nhắn Chung (Public)</h2>
                <div class="min-h-16 flex items-center justify-center">
                    <div id="loader" class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 hidden"></div>
                    <p id="shared-message" class="text-gray-800 text-lg italic">Đang tải dữ liệu...</p>
                </div>
            </section>

            <div class="flex justify-center">
                <button
                    id="update-button"
                    class="px-6 py-3 rounded-full font-semibold text-white transition duration-200 shadow-md bg-gray-400 cursor-not-allowed"
                    disabled
                >
                    Cập nhật Tin nhắn Mẫu (Public)
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ====================================================================
        // KHAI BÁO BIẾN VÀ HÀM HỖ TRỢ
        // ====================================================================

        // Hàm hiển thị lỗi
        const displayError = (message) => {
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            if (errorDiv && errorText) {
                errorText.textContent = message;
                errorDiv.classList.remove('hidden');
            }
            document.getElementById('db-status').textContent = 'Lỗi!';
            document.getElementById('loader').classList.add('hidden');
        };

        // Hàm cập nhật trạng thái UI
        const updateUIStatus = (status, loading = false, disabled = true) => {
            document.getElementById('db-status').textContent = status;
            const loader = document.getElementById('loader');
            const button = document.getElementById('update-button');

            if (loading) {
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }

            if (disabled) {
                button.disabled = true;
                button.classList.remove('bg-green-500', 'hover:bg-green-600', 'focus:ring-green-300');
                button.classList.add('bg-gray-400', 'cursor-not-allowed');
            } else {
                button.disabled = false;
                button.classList.remove('bg-gray-400', 'cursor-not-allowed');
                button.classList.add('bg-green-500', 'hover:bg-green-600', 'focus:ring-4', 'focus:ring-green-300');
            }
        };

        // ====================================================================
        // KHỞI TẠO VÀ XÁC THỰC
        // ====================================================================

        let db;
        let auth;
        let currentAppId = 'default-app-id';
        let currentUserId = null;
        let isAuthReady = false;

        const initializeFirebase = async () => {
            // Đọc các biến toàn cục từ môi trường
            currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            document.getElementById('app-id').textContent = currentAppId;
            updateUIStatus('Đang xác thực...');

            try {
                const firebaseConfig = JSON.parse(firebaseConfigString);
                if (Object.keys(firebaseConfig).length === 0) {
                    // Mặc dù sẽ không xảy ra trong môi trường Canvas, nhưng cần kiểm tra an toàn
                    throw new Error("Firebase config bị thiếu.");
                }

                // 1. Khởi tạo Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                // setLogLevel('debug'); // Bật log nếu cần debug

                // 2. Xác thực
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 3. Lắng nghe trạng thái Auth
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                    } else {
                        // Nếu không có user, dùng ID ẩn danh hoặc ngẫu nhiên
                        currentUserId = auth.currentUser?.uid || crypto.randomUUID();
                    }
                    document.getElementById('user-id').textContent = currentUserId;
                    isAuthReady = true;
                    
                    // Bắt đầu lắng nghe dữ liệu khi Auth đã sẵn sàng
                    setupRealtimeListener();
                });

            } catch (error) {
                console.error("Lỗi khởi tạo hoặc xác thực Firebase:", error);
                displayError(`Lỗi hệ thống: ${error.message || error}`);
            }
        };

        // ====================================================================
        // LẮNG NGHE VÀ XỬ LÝ DỮ LIỆU
        // ====================================================================

        const publicDocPath = () => doc(
            db, 
            `/artifacts/${currentAppId}/public/data/shared_messages`, 
            "welcome_message"
        );

        const setupRealtimeListener = () => {
            if (!db || !currentUserId) return;

            updateUIStatus('Đang tải dữ liệu...', true, true);

            onSnapshot(publicDocPath(), 
                (docSnapshot) => {
                    const messageElement = document.getElementById('shared-message');
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        messageElement.textContent = data.message || "Không có tin nhắn.";
                        updateUIStatus('Sẵn sàng', false, false);
                    } else {
                        // Tạo tài liệu mặc định nếu chưa tồn tại
                        setDoc(publicDocPath(), { message: "Chào mừng đến với Nhật Ký Lớp 2A8!" }, { merge: true })
                            .then(() => {
                                messageElement.textContent = "Chào mừng đến với Nhật Ký Lớp 2A8!";
                                updateUIStatus('Sẵn sàng', false, false);
                            })
                            .catch(err => {
                                console.error("Lỗi tạo tài liệu mặc định:", err);
                                displayError("Không thể tạo dữ liệu mặc định.");
                            });
                    }
                }, 
                (error) => {
                    console.error("Firestore Snapshot Error:", error);
                    displayError("Lỗi khi tải dữ liệu: Vui lòng kiểm tra Quy tắc bảo mật Firestore.");
                }
            );
        };

        // ====================================================================
        // CHỨC NĂNG CẬP NHẬT
        // ====================================================================

        const updateMessage = async () => {
            if (!db || !currentUserId || !isAuthReady) {
                displayError("Hệ thống chưa sẵn sàng để ghi.");
                return;
            }

            updateUIStatus('Đang ghi dữ liệu...', true, true);
            const timestamp = new Date().toLocaleTimeString('vi-VN');
            const truncatedUserId = currentUserId.substring(0, 8) + '...';
            const newMessage = `Tin nhắn được cập nhật bởi ${truncatedUserId} lúc ${timestamp}`;

            try {
                await setDoc(publicDocPath(), { 
                    message: newMessage, 
                    lastUpdatedBy: currentUserId,
                    timestamp: new Date().toISOString()
                }, { merge: true });
                // onSnapshot sẽ tự động cập nhật UI sau khi ghi thành công
            } catch (error) {
                console.error("Lỗi cập nhật tin nhắn:", error);
                displayError("Không thể cập nhật tin nhắn. Vui lòng kiểm tra quyền ghi Firestore.");
            } finally {
                // Đặt lại trạng thái sau khi cập nhật
                updateUIStatus('Sẵn sàng', false, false);
            }
        };

        // ====================================================================
        // GẮN SỰ KIỆN VÀ KHỞI CHẠY
        // ====================================================================
        
        document.getElementById('update-button').addEventListener('click', updateMessage);

        // Khởi động ứng dụng khi cửa sổ tải xong
        window.onload = initializeFirebase;
    </script>
</body>
</html>