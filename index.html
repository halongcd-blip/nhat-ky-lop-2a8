<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhật Ký Lớp 2A8 - Cộng Tác</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .scroll-container {
            max-height: 400px;
            overflow-y: auto;
        }
        /* Custom scrollbar style */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 4px;
        }
        /* Ẩn mũi tên xoay mặc định của input type="number" */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen p-4 md:p-8 flex justify-center transition-opacity duration-300">
        <div class="w-full max-w-4xl bg-white shadow-2xl rounded-2xl p-6 md:p-10 space-y-8">
            <header class="text-center">
                <h1 class="text-4xl font-extrabold text-indigo-700">
                    Nhật Ký Lớp 2A8
                </h1>
                <p class="text-gray-500 mt-2">Cộng tác theo thời gian thực (HTML/JS + Firestore)</p>
                <div id="auth-status" class="mt-3 text-sm font-medium">
                    <!-- Trạng thái Auth sẽ được hiển thị ở đây -->
                </div>
            </header>

            <!-- Khung Báo lỗi và Tải -->
            <div id="error-message" class="hidden p-4 bg-red-100 text-red-700 border border-red-300 rounded-lg"></div>
            <div id="loading-spinner" class="hidden text-center py-4">
                <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-indigo-500 border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status">
                    <span class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Đang tải...</span>
                </div>
                <p class="text-indigo-600 mt-2">Đang tải dữ liệu và xác thực...</p>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- CỘT 1: NHẬT KÝ THEO NGÀY -->
                <section class="p-6 bg-blue-50 rounded-xl shadow-lg space-y-4">
                    <h2 class="text-2xl font-bold text-blue-700 border-b pb-2">1. Nhật Ký Chung (Mọi người xem)</h2>
                    
                    <div class="flex space-x-2">
                        <label for="date-input" class="text-gray-600 self-center">Chọn Ngày:</label>
                        <input type="date" id="date-input" class="p-2 border border-gray-300 rounded-lg flex-grow focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Vùng hiển thị Nhật ký (Read-only) -->
                    <div class="scroll-container bg-white p-3 border border-gray-300 rounded-lg min-h-[150px]">
                        <p id="daily-note-display" class="whitespace-pre-wrap text-gray-700 italic">Chọn một ngày để xem nhật ký...</p>
                    </div>

                    <!-- Vùng nhập liệu và chỉnh sửa -->
                    <textarea id="daily-note-input" rows="5" placeholder="Nhập nhật ký và thông báo cho ngày đã chọn..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm"></textarea>

                    <button id="save-note-button" class="w-full bg-blue-600 text-white py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 shadow-md disabled:bg-gray-400" disabled>
                        Lưu Nhật Ký Ngày
                    </button>
                </section>

                <!-- CỘT 2: DANH SÁCH THÀNH VIÊN VÀ ĐIỂM -->
                <section class="p-6 bg-green-50 rounded-xl shadow-lg space-y-4">
                    <h2 class="text-2xl font-bold text-green-700 border-b pb-2">2. Danh Sách Thành Viên & Bảng Điểm</h2>
                    
                    <button id="add-member-button" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-700 transition duration-150 shadow-md disabled:bg-gray-400" disabled>
                        + Thêm Thành Viên Mới
                    </button>

                    <!-- Bảng Điểm -->
                    <div class="scroll-container">
                        <table class="min-w-full bg-white rounded-lg shadow-inner">
                            <thead class="sticky top-0 bg-green-100">
                                <tr>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">STT</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase">Tên Thành Viên</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase w-20">Điểm (Edit)</th>
                                    <th class="p-3 text-left text-xs font-semibold text-gray-600 uppercase w-10">Xóa</th>
                                </tr>
                            </thead>
                            <tbody id="member-list-body">
                                <!-- Dữ liệu thành viên sẽ được tải ở đây -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- CHÂN TRANG: Hướng dẫn và trạng thái -->
            <footer class="text-center pt-6 border-t mt-6 text-gray-400 text-xs">
                <p>Mã ứng dụng: <span id="app-id-display" class="font-mono text-gray-600">...</span></p>
                <p class="mt-1">Dữ liệu được lưu trữ an toàn trên Google Firestore.</p>
            </footer>
        </div>
    </div>
    
    <!-- Modal cho việc thêm thành viên (thay thế prompt()) -->
    <div id="add-member-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4 text-green-700">Thêm Thành Viên</h3>
            <input type="text" id="new-member-name-input" placeholder="Nhập tên thành viên (ví dụ: Bé An)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 mb-4">
            <div class="flex justify-end space-x-3">
                <button id="cancel-add-member" class="px-4 py-2 bg-gray-300 rounded-lg hover:bg-gray-400">Hủy</button>
                <button id="confirm-add-member" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Thêm</button>
            </div>
        </div>
    </div>


    <!-- ====================================================================\r\n\t\t\t\t\t\tLOGIC JAVASCRIPT & FIREBASE\r\n\t\t==================================================================== -->
    <script type="module">
        // Import Firebase SDKs (v11.6.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Bật Debug Log cho Firestore
        setLogLevel('Debug');

        // Khai báo biến toàn cục (sẽ được khởi tạo sau)
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;
        
        // Lấy các biến toàn cục Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Element DOM
        const appContainer = document.getElementById('app');
        const authStatusEl = document.getElementById('auth-status');
        const errorEl = document.getElementById('error-message');
        const loadingSpinnerEl = document.getElementById('loading-spinner');
        const dateInput = document.getElementById('date-input');
        const dailyNoteDisplay = document.getElementById('daily-note-display');
        const dailyNoteInput = document.getElementById('daily-note-input');
        const saveNoteButton = document.getElementById('save-note-button');
        const addMemberButton = document.getElementById('add-member-button');
        const memberListBody = document.getElementById('member-list-body');
        
        // Modal DOM
        const addMemberModal = document.getElementById('add-member-modal');
        const newMemberNameInput = document.getElementById('new-member-name-input');
        const confirmAddMemberButton = document.getElementById('confirm-add-member');
        const cancelAddMemberButton = document.getElementById('cancel-add-member');

        // Dữ liệu tạm thời (cache)
        let dailyNotes = {}; // { 'YYYY-MM-DD': { note: '...' } }
        let members = []; // Array of member objects

        // ====================================================================\r\n\t\t// HÀM TIỆN ÍCH\r\n\t\t// ====================================================================\r\n
        
        function displayError(message) {
            errorEl.textContent = 'Lỗi: ' + message;
            errorEl.classList.remove('hidden');
        }

        function hideError() {
            errorEl.classList.add('hidden');
        }

        function updateLoading(show) {
            loadingSpinnerEl.classList.toggle('hidden', !show);
            appContainer.classList.toggle('opacity-50', show);
            appContainer.classList.toggle('pointer-events-none', show);
        }

        function updateUIStatus(status) {
            authStatusEl.innerHTML = `Trạng thái: 
                <span class="text-indigo-600 font-bold">${status}</span> | 
                UserID: <span class="font-mono text-gray-700">${userId ? userId.substring(0, 8) + '...' : 'Đang xác thực'}</span>`;
            
            const isReady = isAuthReady && userId;
            saveNoteButton.disabled = !isReady;
            addMemberButton.disabled = !isReady;
            dailyNoteInput.disabled = !isReady;
        }

        // ====================================================================\r\n\t\t// ĐƯỜNG DẪN FIRESTORE (PUBLIC)\r\n\t\t// ====================================================================\r\n
        
        // Đường dẫn đến collection chứa nhật ký hàng ngày (public)
        function dailyNotesCollectionPath() {
            return collection(db, `artifacts/${appId}/public/data/dailyNotes`);
        }

        // Đường dẫn đến document của nhật ký theo ngày cụ thể (public)
        function dailyNoteDocPath(dateKey) {
            return doc(db, `artifacts/${appId}/public/data/dailyNotes/${dateKey}`);
        }

        // Đường dẫn đến collection chứa danh sách thành viên (public)
        function membersCollectionPath() {
            return collection(db, `artifacts/${appId}/public/data/members`);
        }

        // ====================================================================\r\n\t\t// LOGIC NHẬT KÝ\r\n\t\t// ====================================================================\r\n

        // Lấy ngày hiện tại ở định dạng YYYY-MM-DD
        function getTodayDateKey() {
            return new Date().toISOString().split('T')[0];
        }

        // Cập nhật giao diện Nhật ký dựa trên ngày được chọn
        function renderDailyNote(dateKey) {
            const data = dailyNotes[dateKey];
            if (data && data.note) {
                dailyNoteDisplay.textContent = data.note;
                dailyNoteInput.value = data.note;
            } else {
                dailyNoteDisplay.textContent = `Chưa có nhật ký cho ngày ${dateKey}.`;
                dailyNoteInput.value = '';
            }
        }

        // Lưu nhật ký cho ngày được chọn
        async function saveDailyNote() {
            if (!isAuthReady || !userId) {
                displayError("Chưa xác thực. Vui lòng thử lại.");
                return;
            }
            const dateKey = dateInput.value;
            const noteContent = dailyNoteInput.value.trim();

            if (!dateKey) {
                displayError("Vui lòng chọn ngày trước khi lưu.");
                return;
            }

            if (!noteContent) {
                // Nếu nội dung trống, xóa doc nếu tồn tại
                if (dailyNotes[dateKey]) {
                    // Yêu cầu xóa nhật ký ngày này
                    console.log("Nội dung trống. Đã yêu cầu xóa nhật ký ngày này.");
                    
                    try {
                        await deleteDoc(dailyNoteDocPath(dateKey));
                        delete dailyNotes[dateKey]; // Cập nhật cache
                        renderDailyNote(dateKey);
                        updateUIStatus('Đã xóa nhật ký');
                    } catch(e) {
                        displayError("Lỗi khi xóa nhật ký: " + e.message);
                    }
                    return;
                }
                displayError("Nội dung không được để trống.");
                return;
            }

            updateLoading(true);
            try {
                await setDoc(dailyNoteDocPath(dateKey), {
                    date: dateKey,
                    note: noteContent,
                    lastUpdated: new Date().toISOString(),
                    updaterId: userId
                });
                updateUIStatus('Đã lưu nhật ký thành công!');
            } catch (error) {
                console.error("Lỗi khi lưu nhật ký:", error);
                displayError("Không thể lưu nhật ký. Vui lòng kiểm tra console.");
            } finally {
                updateLoading(false);
            }
        }

        // ====================================================================\r\n\t\t// LOGIC THÀNH VIÊN VÀ ĐIỂM\r\n\t\t// ====================================================================\r\n
        
        // Mở Modal thêm thành viên
        function showAddMemberModal() {
            newMemberNameInput.value = '';
            addMemberModal.classList.remove('hidden');
            newMemberNameInput.focus(); // Tập trung vào input
        }
        
        // Đóng Modal thêm thành viên
        function hideAddMemberModal() {
            addMemberModal.classList.add('hidden');
        }

        // Xử lý Thêm thành viên mới
        async function handleConfirmAddMember() {
            const newName = newMemberNameInput.value.trim();
            hideAddMemberModal();
            
            if (!newName) return;

            updateLoading(true);
            try {
                // Tên document là tên viết thường, không khoảng trắng, loại bỏ dấu (giúp tạo ID Firestore hợp lệ)
                const docId = newName.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\s/g, '_');
                
                await setDoc(doc(membersCollectionPath(), docId), { 
                    name: newName, 
                    score: 0, 
                    createdAt: new Date().toISOString(),
                    createdBy: userId
                });
                updateUIStatus('Đã thêm thành viên mới: ' + newName);
            } catch (error) {
                console.error("Lỗi khi thêm thành viên:", error);
                displayError("Không thể thêm thành viên. Tên có thể đã tồn tại.");
            } finally {
                updateLoading(false);
            }
        }

        // Cập nhật điểm thành viên (inline edit)
        async function updateMemberScore(memberId, newScore) {
            if (!isAuthReady || !userId) {
                displayError("Chưa xác thực.");
                return;
            }
            const scoreNum = parseInt(newScore);
            
            // Nếu giá trị không phải là số hợp lệ, reset về 0
            if (isNaN(scoreNum)) {
                console.warn("Điểm nhập vào không phải là số. Đặt lại về 0.");
                
                // Tìm input element và reset giá trị về 0
                const inputElement = memberListBody.querySelector(`input[data-member-id="${memberId}"]`);
                if (inputElement) {
                    inputElement.value = 0;
                }
                
                try {
                     // Ghi lại điểm 0 vào Firestore
                    await setDoc(doc(membersCollectionPath(), memberId), { 
                        score: 0,
                        lastScoreUpdate: new Date().toISOString()
                    }, { merge: true });
                } catch (error) {
                    console.error("Lỗi khi đặt lại điểm:", error);
                }
                return;
            }

            try {
                // Tên document chính là memberId
                await setDoc(doc(membersCollectionPath(), memberId), { 
                    score: scoreNum,
                    lastScoreUpdate: new Date().toISOString()
                }, { merge: true });
                // onSnapshot sẽ tự động cập nhật UI
            } catch (error) {
                console.error("Lỗi khi cập nhật điểm:", error);
                displayError("Không thể cập nhật điểm.");
            }
        }

        // Xóa thành viên
        async function deleteMember(memberId, memberName) {
            // Thay thế confirm() bằng một box thông báo tùy chỉnh (dùng window.confirm tạm thời)
            if (!window.confirm(`Bạn có chắc chắn muốn xóa thành viên ${memberName} khỏi danh sách không?`)) return;

            updateLoading(true);
            try {
                await deleteDoc(doc(membersCollectionPath(), memberId));
                updateUIStatus(`Đã xóa thành viên: ${memberName}`);
            } catch (error) {
                console.error("Lỗi khi xóa thành viên:", error);
                displayError("Không thể xóa thành viên.");
            } finally {
                updateLoading(false);
            }
        }

        // Render bảng thành viên
        function renderMemberList() {
            memberListBody.innerHTML = ''; // Clear old content
            
            // Sắp xếp theo điểm giảm dần và tên tăng dần
            const sortedMembers = [...members].sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score; // Điểm cao hơn lên trước
                }
                return a.name.localeCompare(b.name, 'vi', { sensitivity: 'base' }); // Sắp xếp theo tên
            });

            sortedMembers.forEach((member, index) => {
                const tr = document.createElement('tr');
                tr.className = 'border-b hover:bg-gray-50';
                const memberId = member.id;

                tr.innerHTML = `
                    <td class="p-3 text-sm text-gray-700">${index + 1}</td>
                    <td class="p-3 text-sm text-gray-900 font-medium">${member.name}</td>
                    <td class="p-3">
                        <input type="number" 
                               value="${member.score}" 
                               data-member-id="${memberId}" 
                               class="w-full p-1 border border-gray-300 rounded text-center focus:ring-green-500 focus:border-green-500"
                        />
                    </td>
                    <td class="p-3 text-center">
                        <button data-member-id="${memberId}" data-member-name="${member.name}" class="delete-member-btn text-red-500 hover:text-red-700 font-bold text-lg">
                            &times;
                        </button>
                    </td>
                `;
                memberListBody.appendChild(tr);
            });

            // Gắn sự kiện cho các input điểm
            memberListBody.querySelectorAll('input[type="number"]').forEach(input => {
                // Sự kiện change để cập nhật khi người dùng nhấn Enter hoặc click ra ngoài
                input.addEventListener('change', (e) => {
                    const memberId = e.target.dataset.memberId;
                    updateMemberScore(memberId, e.target.value);
                });
                // Sự kiện input để kiểm soát người dùng chỉ nhập số
                input.addEventListener('input', (e) => {
                    // Đảm bảo chỉ là số nguyên
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            });

            // Gắn sự kiện cho nút xóa
            memberListBody.querySelectorAll('.delete-member-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    // Lấy element cha để đảm bảo lấy đúng dataset
                    const targetButton = e.currentTarget; 
                    const memberId = targetButton.dataset.memberId;
                    const memberName = targetButton.dataset.memberName;
                    deleteMember(memberId, memberName);
                });
            });
        }

        // ====================================================================\r\n\t\t// KHỞI TẠO VÀ LẮNG NGHE (LISTENERS)\r\n\t\t// ====================================================================\r\n

        // Lắng nghe thay đổi từ Firestore
        function setupFirestoreListeners() {
            // 1. Lắng nghe Nhật ký hàng ngày (dailyNotes)
            // LƯU Ý: Không dùng orderBy vì sẽ yêu cầu index phức tạp hơn, chỉ dùng onSnapshot và sắp xếp client-side nếu cần.
            onSnapshot(dailyNotesCollectionPath(), (snapshot) => {
                dailyNotes = {};
                snapshot.forEach(doc => {
                    dailyNotes[doc.id] = doc.data();
                });
                // Cập nhật giao diện với ngày hiện tại (hoặc ngày đã chọn)
                const selectedDate = dateInput.value || getTodayDateKey();
                renderDailyNote(selectedDate);
            }, (error) => {
                console.error("Lỗi lắng nghe Nhật ký:", error);
                displayError("Lỗi kết nối Nhật ký. Vui lòng kiểm tra quyền truy cập.");
            });

            // 2. Lắng nghe Danh sách Thành viên (members)
            onSnapshot(membersCollectionPath(), (snapshot) => {
                members = [];
                snapshot.forEach(doc => {
                    members.push({ id: doc.id, ...doc.data() });
                });
                renderMemberList();
            }, (error) => {
                console.error("Lỗi lắng nghe Thành viên:", error);
                displayError("Lỗi kết nối Danh sách Thành viên. Vui lòng kiểm tra quyền truy cập.");
            });
        }

        // Khởi tạo Firebase và Xác thực
        async function initializeFirebase() {
            updateLoading(true);
            document.getElementById('app-id-display').textContent = appId;
            
            try {
                // 1. Khởi tạo App, Auth, Firestore
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 2. Xác thực
                let authPromise;
                if (initialAuthToken) {
                    authPromise = signInWithCustomToken(auth, initialAuthToken);
                } else {
                    authPromise = signInAnonymously(auth);
                }
                await authPromise;

                // 3. Thiết lập listener Auth
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        updateUIStatus('Đã kết nối');
                        setupFirestoreListeners(); // Bắt đầu lắng nghe dữ liệu sau khi Auth thành công
                    } else {
                        userId = null;
                        isAuthReady = false;
                        updateUIStatus('Chưa xác thực');
                        displayError("Không thể xác thực người dùng. Dữ liệu sẽ không tải.");
                    }
                    updateLoading(false);
                });

            } catch (error) {
                console.error("Lỗi khởi tạo Firebase:", error);
                displayError("KHÔNG THỂ KHỞI TẠO. Vui lòng kiểm tra lại Firebase Config và API Key.");
                updateLoading(false);
            }
        }
        
        // ====================================================================\r\n\t\t// GẮN SỰ KIỆN VÀ KHỞI CHẠY\r\n\t\t// ====================================================================\r\n

        // Thiết lập ngày mặc định là hôm nay
        dateInput.value = getTodayDateKey();

        // Gắn sự kiện cho việc chọn ngày
        dateInput.addEventListener('change', (e) => {
            renderDailyNote(e.target.value);
        });

        // Gắn sự kiện cho nút Lưu Nhật ký
        saveNoteButton.addEventListener('click', saveDailyNote);

        // Gắn sự kiện cho nút Thêm Thành viên (Mở modal)
        addMemberButton.addEventListener('click', showAddMemberModal);
        
        // Gắn sự kiện cho Modal
        cancelAddMemberButton.addEventListener('click', hideAddMemberModal);
        confirmAddMemberButton.addEventListener('click', handleConfirmAddMember);
        // Cho phép nhấn Enter trong input để xác nhận
        newMemberNameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleConfirmAddMember();
            }
        });

        // Khởi động ứng dụng khi cửa sổ tải xong
        window.onload = initializeFirebase;
    </script>
</body>
</html>